#
# Makefile for MARS
#

obj-$(CONFIG_MARS)	+= mars.o

KBUILD_CFLAGS += -fdelete-null-pointer-checks

mars-objs :=				\
	lamport.o			\
	brick_say.o			\
	brick_mem.o			\
	brick.o				\
	xio_bricks/xio.o			\
	xio_bricks/lib_log.o			\
	lib_rank.o			\
	lib_limiter.o			\
	lib_timing.o			\
	xio_bricks/lib_mapfree.o			\
	xio_bricks/xio_net.o			\
	xio_bricks/xio_server.o			\
	xio_bricks/xio_client.o			\
	xio_bricks/xio_aio.o			\
	xio_bricks/xio_bio.o			\
	xio_bricks/xio_if.o			\
	xio_bricks/xio_copy.o			\
	xio_bricks/xio_trans_logger.o		\
	mars_light/light_strategy.o		\
	mars_light/light_net.o			\
	mars_light/mars_proc.o		\
	mars_light/mars_light.o

ifdef CONFIG_DEBUG_KERNEL

KBUILD_CFLAGS += -fno-inline-functions -fno-inline-small-functions -fno-inline-functions-called-once

## remove_this
# This is currently not really used.
# We urge people to maintain it by including it in debug versions
# (so the compiler may throw any complaints)

mars-objs += 				\
	xio_bricks/unused/xio_dummy.o			\
	xio_bricks/unused/xio_check.o			\
	xio_bricks/unused/xio_sio.o			\
	xio_bricks/unused/xio_buf.o			\
	xio_bricks/unused/xio_usebuf.o			\

## end_remove_this
endif

## remove_this
#
# buildtag.h should be regenerated in every build. If a file
# 'DISTVERSION' exists (out-of-tree tarball), its content is
# used as the BUILDTAG. Otherwise, if git is available, the
# git HEAD revision is used instead.
#
extra-y	+= buildtag.h
$(obj)/buildtag.h: $(patsubst $(obj)/buildtag.h,,$(wildcard $(obj)/*.[ch])) $(obj)/*/*.[ch]
	$(Q)$(kecho) "MARS: Generating $@"
	$(Q)set -e; \
	exec > $@;\
	/bin/echo -e "/* Automatically generated -- DO NOT EDIT! */";\
	cd $(src); \
	if [ -e DISTVERSION ]; then \
		BUILDTAG=$$(cat DISTVERSION); \
	elif git describe --tags >/dev/null 2>&1; then \
		BUILDTAG="$$(git describe --tags)"; \
	else \
		BUILDTAG="no-buildtag-available"; \
	fi; \
	/bin/echo -e "#define BUILDTAG  \"$$BUILDTAG\"";\
	/bin/echo -e "#define BUILDHOST \"$$USER@`hostname`\"";\
	/bin/echo -e "#define BUILDDATE \"$$(date '+%F %T')\""

ifndef CONFIG_MARS
# mars_config.h is generated by a simple Kconfig parser (gen_config.pl)
# at build time.
# It does not respect any Kconfig dependencies.
# Therefore, it is unsafe. Use at your own risk!
# It is ONLY used for out-of-tree builds.
#
extra-y	+= mars_config.h
GEN_CONFIG_SCRIPT := $(src)/../scripts/gen_config.pl
$(obj)/mars_config.h: $(src)/Kconfig $(GEN_CONFIG_SCRIPT)
	$(Q)$(kecho) "MARS: Generating $@"
	$(Q)set -e; \
	if [ ! -x $(GEN_CONFIG_SCRIPT) ]; then \
	    $(kecho) "MARS: cannot execute script $(GEN_CONFIG_SCRIPT)"; \
	    /bin/false; \
	fi; \
	cat $< | $(GEN_CONFIG_SCRIPT) > $@;
endif

## end_remove_this
